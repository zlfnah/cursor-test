<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Community - Upgraded</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #5a67d2;
            --primary-color-light: #e0e3ff;
            --background-color: #f7fafc;
            --card-background: #ffffff;
            --text-color: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }
        body {
            font-family: 'Pretendard', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        #root { display: flex; justify-content: center; padding: 20px; }
        .main-layout { display: grid; grid-template-columns: 1fr 300px; gap: 24px; width: 100%; max-width: 1200px; }
        .main-feed { width: 100%; }
        .sidebar { width: 100%; }
        
        /* Header */
        .header {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }
        .header-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .new-post-btn {
            background-color: var(--primary-color); color: white; border: none; padding: 12px 24px;
            border-radius: var(--radius); font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;
        }
        .new-post-btn:hover { background-color: #4c51bf; transform: translateY(-2px); }

        /* Feed Controls */
        .feed-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .feed-toggle { display: flex; gap: 8px; }
        .toggle-btn {
            background: none; border: none; padding: 8px 12px; border-radius: 8px;
            cursor: pointer; font-size: 1rem; font-weight: 500; color: var(--text-muted);
        }
        .toggle-btn.active { color: var(--primary-color); background-color: var(--primary-color-light); }
        
        /* Post Card */
        .post-card {
            background: var(--card-background); border-radius: var(--radius); margin-bottom: 16px;
            padding: 24px; box-shadow: var(--shadow); cursor: pointer; transition: all 0.2s ease;
        }
        .post-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; }
        .author-info .author-name { font-weight: 700; }
        .author-info .post-date { font-size: 0.875rem; color: var(--text-muted); }
        .post-card h2 { margin: 0 0 12px; font-size: 1.25rem; }
        .post-card .post-content-preview {
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .post-footer { display: flex; align-items: center; gap: 20px; margin-top: 20px; color: var(--text-muted); }
        .post-footer .action-btn { display: flex; align-items: center; gap: 8px; }
        .tags-container { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { background-color: var(--primary-color-light); color: var(--primary-color); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500;}

        /* Sidebar Widgets */
        .sidebar-widget {
            background: var(--card-background); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 24px;
        }
        .widget-title { font-size: 1.125rem; font-weight: 700; margin: 0 0 16px 0; }
        .search-input { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-list .tag { cursor: pointer; }
        .profile-widget { text-align: center; }
        .profile-widget .avatar { width: 80px; height: 80px; margin: 0 auto 12px; }

        /* Modal & Form */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--card-background); padding: 30px; border-radius: var(--radius); width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-muted); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: inherit; }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .submit-btn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 700; }

        /* Detail View */
        .post-detail-header h1 { font-size: 2rem; margin: 0 0 10px; }
        .post-detail-content { line-height: 1.8; margin: 20px 0; }
        .action-btn {
            display: flex; align-items: center; gap: 8px; background: none; border: none;
            cursor: pointer; font-size: 1rem; color: var(--text-muted);
        }
        .action-btn.liked { color: #ef4444; font-weight: 700; }
        .comment {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, StrictMode } = React;

        const usePersistentState = (key, defaultValue) => {
            const [state, setState] = useState(() => {
                try {
                    const storedValue = localStorage.getItem(key);
                    return storedValue ? JSON.parse(storedValue) : defaultValue;
                } catch (e) { 
                    console.error(`Error reading localStorage key “${key}”:`, e);
                    return defaultValue; 
                }
            });
            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (e) {
                    console.error(`Error setting localStorage key “${key}”:`, e);
                }
            }, [key, state]);
            return [state, setState];
        };

        const initialPosts = [
            { id: 1, title: "리액트, 이렇게 시작하세요!", content: "리액트는 사용자 인터페이스를 만들기 위한 JavaScript 라이브러리입니다. Virtual DOM을 사용하여 뛰어난 성능을 자랑하죠. 이 글에서는 리액트의 기본 개념부터 Hooks 사용법까지 차근차근 알아봅니다.", author: "김민준", tags: "React,JavaScript", createdAt: "2024-07-30T10:00:00Z" },
            { id: 2, title: "CSS-in-JS, 정말 필요할까?", content: "styled-components와 Emotion을 비교하며 장단점을 알아봅니다. CSS Modules와의 차이점도 함께 다루어 프로젝트에 가장 적합한 스타일링 방법을 선택할 수 있도록 도와드립니다.", author: "이서아", tags: "CSS,WebDev", createdAt: "2024-07-29T14:30:00Z" }
        ];

        const App = () => {
            const [posts, setPosts] = usePersistentState('community_posts', initialPosts);
            const [comments, setComments] = usePersistentState('community_comments', {});
            const [likes, setLikes] = usePersistentState('community_likes', {});
            
            const [view, setView] = useState({ type: 'feed', postId: null });
            const [isNewPostModalOpen, setNewPostModalOpen] = useState(false);
            const [feedType, setFeedType] = useState('latest');
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                // If the post for the detailed view is no longer available (e.g., deleted), switch back to the feed.
                if (view.type === 'detail' && view.postId && !posts.some(p => p.id === view.postId)) {
                    setView({ type: 'feed', postId: null });
                }
            }, [view, posts]);

            const addPost = (post) => {
                setPosts(prev => [{ ...post, id: Date.now(), createdAt: new Date().toISOString() }, ...prev]);
                setNewPostModalOpen(false);
            };

            const addComment = (postId, comment) => {
                setComments(p => ({ ...p, [postId]: [...(p[postId] || []), { ...comment, id: Date.now() }] }));
            };

            const toggleLike = (postId) => {
                setLikes(p => ({ ...p, [postId]: !p[postId] }));
            };

            const deletePost = (postId) => {
                if (window.confirm("정말로 이 글을 삭제하시겠습니까?")) {
                    setPosts(posts.filter(p => p.id !== postId));
                    const newComments = {...comments}; delete newComments[postId]; setComments(newComments);
                    const newLikes = {...likes}; delete newLikes[postId]; setLikes(newLikes);
                }
            };

            const filteredPosts = useMemo(() => posts.filter(post => 
                post.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
                post.author.toLowerCase().includes(searchTerm.toLowerCase()) ||
                post.tags.toLowerCase().includes(searchTerm.toLowerCase())
            ), [posts, searchTerm]);

            const sortedPosts = useMemo(() => {
                const getLikeCount = (postId) => Object.keys(likes).filter(key => likes[key] && parseInt(key) === postId).length;
                const getCommentCount = (postId) => (comments[postId] || []).length;

                const postsWithCounts = filteredPosts.map(post => ({
                    ...post,
                    likeCount: getLikeCount(post.id),
                    commentCount: getCommentCount(post.id),
                }));

                if (feedType === 'popular') {
                    return [...postsWithCounts].sort((a, b) => (b.likeCount + b.commentCount) - (a.likeCount + a.commentCount));
                }
                return [...postsWithCounts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }, [filteredPosts, likes, comments, feedType]);
            
            const trendingTags = useMemo(() => {
                const tagCounts = posts.flatMap(p => p.tags.split(',')).reduce((acc, tag) => {
                    const trimmedTag = tag.trim();
                    if (trimmedTag){
                        acc[trimmedTag] = (acc[trimmedTag] || 0) + 1;
                    }
                    return acc;
                }, {});
                return Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(entry => entry[0]);
            }, [posts]);

            const renderContent = () => {
                if (view.type === 'detail' && view.postId) {
                    const post = sortedPosts.find(p => p.id === view.postId);
                    if (!post) return null; // Let the useEffect handle the view switch
                    
                    return <PostDetailView 
                        post={{ ...post, isLiked: !!likes[post.id] }} 
                        comments={comments[post.id] || []}
                        onCommentSubmit={addComment}
                        onLikeToggle={toggleLike}
                        onDeletePost={deletePost}
                        onBack={() => setView({ type: 'feed' })}
                    />
                }
                return <PostFeed posts={sortedPosts} onPostClick={(postId) => setView({ type: 'detail', postId })} />;
            };
            
            return (
                <div className="main-layout">
                    <div className="main-feed">
                        <Header onNewPostClick={() => setNewPostModalOpen(true)} />
                        {view.type === 'feed' && 
                            <div className="feed-controls">
                                <FeedToggle feedType={feedType} onFeedTypeChange={setFeedType} />
                            </div>
                        }
                        {renderContent()}
                    </div>
                    <aside className="sidebar">
                        <Sidebar 
                           searchTerm={searchTerm} 
                           onSearchChange={setSearchTerm} 
                           trendingTags={trendingTags}
                           onTagClick={(tag) => setSearchTerm(tag)}
                        />
                    </aside>
                     {isNewPostModalOpen && <Modal onClose={() => setNewPostModalOpen(false)}><NewPostForm onSubmit={addPost} /></Modal>}
                </div>
            );
        };

        const Avatar = ({ name }) => <img className="avatar" src={`https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&font-size=0.5`} alt={name} />;

        const Header = ({ onNewPostClick }) => (
            <header className="header">
                <div className="header-title">DevTalk</div>
                <button className="new-post-btn" onClick={onNewPostClick}>새 글 쓰기</button>
            </header>
        );

        const Sidebar = ({ searchTerm, onSearchChange, trendingTags, onTagClick }) => (
            <>
                <div className="sidebar-widget profile-widget">
                    <Avatar name="Guest User" />
                    <h3 className="widget-title">Guest User</h3>
                    <p className="text-muted">커뮤니티에 오신 것을 환영합니다!</p>
                </div>
                <div className="sidebar-widget">
                    <h3 className="widget-title">검색</h3>
                    <input className="search-input" type="text" placeholder="검색어를 입력하세요..." value={searchTerm} onChange={e => onSearchChange(e.target.value)} />
                </div>
                <div className="sidebar-widget">
                    <h3 className="widget-title">인기 태그</h3>
                    <div className="tag-list">
                        {trendingTags.map(tag => <div key={tag} className="tag" onClick={() => onTagClick(tag)}>{tag}</div>)}
                    </div>
                </div>
            </>
        );
        
        const FeedToggle = ({ feedType, onFeedTypeChange }) => (
            <div className="feed-toggle">
                <button className={`toggle-btn ${feedType === 'latest' ? 'active' : ''}`} onClick={() => onFeedTypeChange('latest')}>최신순</button>
                <button className={`toggle-btn ${feedType === 'popular' ? 'active' : ''}`} onClick={() => onFeedTypeChange('popular')}>인기순</button>
            </div>
        );

        const PostFeed = ({ posts, onPostClick }) => (
            <div>
                {posts.length > 0 ? (
                    posts.map(post => <PostCard key={post.id} post={post} onClick={() => onPostClick(post.id)} />)
                ) : (
                    <div className="sidebar-widget">게시물이 없습니다.</div>
                )}
            </div>
        );

        const PostCard = ({ post, onClick }) => (
            <div className="post-card" onClick={onClick}>
                <div className="post-header">
                    <Avatar name={post.author} />
                    <div className="author-info">
                        <div className="author-name">{post.author}</div>
                        <div className="post-date">{new Date(post.createdAt).toLocaleDateString()}</div>
                    </div>
                </div>
                <h2>{post.title}</h2>
                <p className="post-content-preview">{post.content}</p>
                <div className="tags-container">
                    {post.tags && post.tags.split(',').map(tag => <span key={tag} className="tag">{tag.trim()}</span>)}
                </div>
            </div>
        );

        const PostDetailView = ({ post, comments, onCommentSubmit, onLikeToggle, onDeletePost, onBack }) => {
            const [commentText, setCommentText] = useState('');
            const [commentAuthor, setCommentAuthor] = useState('');

            return (
                <div>
                    <button className="toggle-btn" onClick={onBack}>&larr; 목록으로</button>
                    <div className="sidebar-widget" style={{marginTop: '20px'}}>
                        <div className="post-header">
                            <Avatar name={post.author} />
                            <div className="author-info">
                                <div className="author-name">{post.author}</div>
                                <div className="post-date">{new Date(post.createdAt).toLocaleString()}</div>
                            </div>
                        </div>
                        <h1>{post.title}</h1>
                        <div className="tags-container" style={{margin: '10px 0'}}>
                            {post.tags && post.tags.split(',').map(tag => <span key={tag} className="tag">{tag.trim()}</span>)}
                        </div>
                        <p className="post-detail-content" dangerouslySetInnerHTML={{ __html: post.content.replace(/\n/g, '<br />') }} />
                        <div className="post-footer">
                            <button className={`action-btn ${post.isLiked ? 'liked' : ''}`} onClick={() => onLikeToggle(post.id)}>
                                ❤️ 좋아요 {post.likeCount}
                            </button>
                            <button className="action-btn delete-btn" onClick={() => onDeletePost(post.id)}>🗑️ 삭제</button>
                        </div>
                    </div>
                    <div className="sidebar-widget comments-section">
                        <h3>댓글 ({comments.length})</h3>
                        <form onSubmit={(e) => { e.preventDefault(); if(!commentAuthor.trim()||!commentText.trim())return; onCommentSubmit(post.id, { author: commentAuthor, text: commentText }); setCommentText(''); setCommentAuthor(''); }}>
                            <div className="form-group"><input type="text" placeholder="이름" value={commentAuthor} onChange={e => setCommentAuthor(e.target.value)} required/></div>
                            <div className="form-group"><textarea placeholder="댓글을 입력하세요..." value={commentText} onChange={e => setCommentText(e.target.value)} required></textarea></div>
                            <button type="submit" className="new-post-btn submit-btn">댓글 작성</button>
                        </form>
                        <div className="comment-list" style={{marginTop: '20px'}}>
                            {comments.map(c => (
                                <div key={c.id} className="comment">
                                    <div className="post-header" style={{marginBottom: '8px'}}><Avatar name={c.author} /><div className="author-name">{c.author}</div></div>
                                    <p>{c.text}</p>
                                </div>
                            )).reverse()}
                        </div>
                    </div>
                </div>
            );
        };
        
        const Modal = ({ children, onClose }) => ( <div className="modal-overlay" onClick={onClose}><div className="modal-content" onClick={e => e.stopPropagation()}><button className="modal-close-btn" onClick={onClose}>&times;</button>{children}</div></div> );
        
        const NewPostForm = ({ onSubmit }) => {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            const [author, setAuthor] = useState('');
            const [tags, setTags] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!title.trim() || !content.trim() || !author.trim()) return alert("모든 필드를 입력해주세요.");
                onSubmit({ title, content, author, tags });
            };

            return (
                <form onSubmit={handleSubmit}>
                    <h2>새 글 작성</h2>
                    <div className="form-group"><label>제목</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} required/></div>
                    <div className="form-group"><label>작성자</label><input type="text" value={author} onChange={e => setAuthor(e.target.value)} required/></div>
                    <div className="form-group"><label>태그 (쉼표로 구분)</label><input type="text" value={tags} onChange={e => setTags(e.target.value)} /></div>
                    <div className="form-group"><label>내용</label><textarea value={content} onChange={e => setContent(e.target.value)} required></textarea></div>
                    <button type="submit" className="new-post-btn submit-btn">글 올리기</button>
                </form>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StrictMode><App /></StrictMode>);
    </script>
</body>
</html> 